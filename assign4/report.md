### Assignment4
### 准确描述IPSec传输模式下ESP报文的装包和拆包的过程

#### 13331044 邓霭霖 计应1班 邮箱：729880819@qq.com

#### 装包过程
1. 在原IP报文末尾添加尾部信息（ESP trailer）
    尾部信息包括三部分：填充padding，填充的长度pad length，标明被加密的数据报文类型next header
2. 将原IP报文以及第一步得到的ESP尾部作为一个整体加密。加密算法还有密钥由SA给出。
3. 将第二步得到的加密数据添加ESP头部。
    ESP头由SPI和序号两部分组成。
4. 附加完整性度量结果。对第三步得到的信息做摘要，然后附在ESP报文的尾部
5. 加上新的IP头。新构造的IP头附在ESP报文的前面组成一个新的IP报文。这里的新IP地址和源地址可以不一样的。协议类型是50，代表它装的是一个IPsec报文。

#### 拆包过程
1. 接收方收到数据报文之后，发现协议是50，然后知道这是一个IPsec包。然后去查看ESP的头，通过里面的SPI决定数据报文所对应的SA。
2. 计算“enchilada”的摘要，和附在尾部的ICV的信息比对，如果一样的话就说明数据是完整的，确保完整性。
3. 检查Seq里的顺序号，保证信息不过期
4. 根据SA提供的加密算法和密钥，解密出原IP报文和ESP尾部。
5. 根据ESP尾部的填充长度信息（pad length）得到填充信息的长度，去除
6. 根据得到的原IP包的目标地址进行转发



